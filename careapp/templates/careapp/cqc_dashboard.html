{% extends 'careapp/base.html' %}
{% load static %}

{% block content %}
<div class="page-header">
    <h2 class="page-title"><i class="fas fa-shield-alt"></i> CQC Dashboard</h2>
    <div class="header-actions">
        <span class="badge badge-info">CQC ID: {{ cqc_member.cqc_id }}</span>
    </div>
</div>

{% if cqc_member %}
<div class="stats-grid">
    <div class="stat-card">
        <i class="fas fa-exclamation-circle"></i>
        <h3>{{ viewable_incidents.count }}</h3>
        <p>Viewable Incidents</p>
    </div>
    <div class="stat-card">
        <i class="fas fa-file-alt"></i>
        <h3>{{ accessible_documents.count }}</h3>
        <p>Accessible Documents</p>
    </div>
    {% if cqc_member.can_view_audit_logs %}
    <div class="stat-card">
        <i class="fas fa-history"></i>
        <h3>{{ recent_audit_logs.count }}</h3>
        <p>Recent Audit Logs</p>
    </div>
    {% endif %}
    {% if cqc_member.can_view_care_plans %}
    <div class="stat-card">
        <i class="fas fa-clipboard-list"></i>
        <h3>{{ accessible_care_plans.count }}</h3>
        <p>Accessible Care Plans</p>
    </div>
    {% endif %}
</div>

<div class="dashboard-sections">
    <div class="dashboard-section">
        <h3><i class="fas fa-exclamation-circle"></i> Recent Incidents</h3>
        <div class="card">
            <div class="card-body">
                {% if viewable_incidents %}
                <div class="incident-list">
                    {% for incident in viewable_incidents %}
                    <div class="incident-item">
                        <div class="incident-header">
                            <h4>{{ incident.title }}</h4>
                            <span class="badge badge-{{ incident.severity }}">{{ incident.get_severity_display }}</span>
                        </div>
                        <p>{{ incident.service_user.first_name }} {{ incident.service_user.last_name }} | {{ incident.date }}</p>
                        <p class="incident-desc">{{ incident.description|truncatewords:20 }}</p>
                        <div class="incident-meta">
                            <span>Type: {{ incident.get_incident_type_display }}</span>
                            <span>Reported: {{ incident.created_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No viewable incidents found.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="dashboard-section">
        <h3><i class="fas fa-file-alt"></i> Accessible Documents</h3>
        <div class="card">
            <div class="card-body">
                {% if accessible_documents %}
                <div class="document-list">
                    {% for document in accessible_documents %}
                    <div class="document-item">
                        <div class="document-header">
                            <h4>{{ document.title }}</h4>
                            <span class="badge badge-{{ document.document_type }}">{{ document.get_document_type_display }}</span>
                        </div>
                        <p class="document-desc">{{ document.description|truncatewords:15 }}</p>
                        <div class="document-meta">
                            <span>Created: {{ document.created_at|date:"M d, Y" }}</span>
                            {% if document.service_user %}
                            <span>User: {{ document.service_user.first_name }} {{ document.service_user.last_name }}</span>
                            {% endif %}
                        </div>
                        <div class="document-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="location.href='{% url 'document_detail' document.pk %}'">
                                View Details
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No accessible documents found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if cqc_member.can_view_audit_logs and recent_audit_logs %}
<div class="dashboard-section">
    <h3><i class="fas fa-history"></i> Recent Audit Logs</h3>
    <div class="card">
        <div class="card-body">
            <div class="audit-list">
                {% for log in recent_audit_logs %}
                <div class="audit-item">
                    <div class="audit-header">
                        <h4>{{ log.user.get_full_name }}</h4>
                        <span class="badge badge-{{ log.action }}">{{ log.get_action_display }}</span>
                    </div>
                    <p class="audit-desc">{{ log.model_name }} - {{ log.details }}</p>
                    <div class="audit-meta">
                        <span>{{ log.created_at|date:"M d, Y H:i" }}</span>
                        <span>IP: {{ log.ip_address }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if cqc_member.can_view_care_plans and accessible_care_plans %}
<div class="dashboard-section">
    <h3><i class="fas fa-clipboard-list"></i> Accessible Care Plans</h3>
    <div class="card">
        <div class="card-body">
            <div class="careplan-list">
                {% for careplan in accessible_care_plans %}
                <div class="careplan-item">
                    <div class="careplan-header">
                        <h4>Care Plan for {{ careplan.service_user.first_name }} {{ careplan.service_user.last_name }}</h4>
                        <span class="badge {% if careplan.is_due_for_review %}badge-warning{% else %}badge-success{% endif %}">
                            {% if careplan.is_due_for_review %}Due for Review{% else %}Up to Date{% endif %}
                        </span>
                    </div>
                    <div class="careplan-meta">
                        <span>Last Review: {{ careplan.last_review_date|date:"M d, Y" }}</span>
                        <span>Next Review: {{ careplan.next_review_date|date:"M d, Y" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<div class="alert alert-warning">
    <p>CQC profile not found. Please contact administrator.</p>
</div>
{% endif %}

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stat-card i {
    font-size: 2.5rem;
    color: var(--primary-color);
    margin-bottom: 15px;
}

.stat-card h3 {
    font-size: 2rem;
    margin: 10px 0;
    color: var(--secondary-color);
}

.stat-card p {
    color: #666;
    margin: 0;
}

.dashboard-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 30px;
}

.dashboard-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.dashboard-section h3 {
    margin-bottom: 15px;
    color: var(--secondary-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.incident-item, .document-item, .audit-item, .careplan-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
}

.incident-item:last-child, .document-item:last-child, .audit-item:last-child, .careplan-item:last-child {
    border-bottom: none;
}

.incident-header, .document-header, .audit-header, .careplan-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.incident-header h4, .document-header h4, .audit-header h4, .careplan-header h4 {
    margin: 0;
    flex: 1;
}

.incident-desc, .document-desc, .audit-desc {
    color: #666;
    margin-bottom: 10px;
}

.incident-meta, .document-meta, .audit-meta, .careplan-meta {
    display: flex;
    gap: 15px;
    font-size: 12px;
    color: #888;
    margin-bottom: 10px;
}

.document-actions {
    margin-top: 10px;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 12px;
}

.btn-outline-primary {
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    background: transparent;
}

.btn-outline-primary:hover {
    background: var(--primary-color);
    color: white;
}

.badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.badge-success { background: #28a745; color: white; }
.badge-warning { background: #ffc107; color: black; }
.badge-info { background: #17a2b8; color: white; }
.badge-low { background: #28a745; color: white; }
.badge-medium { background: #ffc107; color: black; }
.badge-high { background: #fd7e14; color: white; }
.badge-critical { background: #dc3545; color: white; }
.badge-create { background: #28a745; color: white; }
.badge-update { background: #17a2b8; color: white; }
.badge-delete { background: #dc3545; color: white; }
.badge-view { background: #6f42c1; color: white; }
.badge-care_plan { background: #6f42c1; color: white; }
.badge-assessment { background: #20c997; color: white; }
.badge-policy { background: #fd7e14; color: white; }

@media (max-width: 768px) {
    .dashboard-sections {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .incident-header, .document-header, .audit-header, .careplan-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .incident-meta, .document-meta, .audit-meta, .careplan-meta {
        flex-direction: column;
        gap: 5px;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}