{% extends 'careapp/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="page-header">
    <h2 class="page-title">
        <i class="fas fa-{% if object %}edit{% else %}plus{% endif %}"></i>
        {% if object %}Edit{% else %}Create{% endif %} Management Note
    </h2>
    <div class="header-actions">
        <button class="btn btn-outline-secondary" onclick="location.href='{% url 'managementdailynote_list' %}'">
            <i class="fas fa-arrow-left"></i> Cancel
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            {{ form.title|as_crispy_field }}
            {{ form.priority|as_crispy_field }}
            {{ form.note|as_crispy_field }}
            
            <div class="row">
                <div class="col-md-4">
                    {{ form.related_department|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.related_service_user|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.related_staff|as_crispy_field }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    {{ form.action_required|as_crispy_field }}
                </div>
            </div>
            
            <div id="actionFields" style="display: none;">
                {{ form.action_details|as_crispy_field }}
                {{ form.action_deadline|as_crispy_field }}
            </div>
            
            {% if object %}
            <div class="row">
                <div class="col-md-6">
                    {{ form.is_resolved|as_crispy_field }}
                </div>
            </div>
            
            <div id="resolutionFields" style="display: none;">
                {{ form.resolution_notes|as_crispy_field }}
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {% if object %}Update{% else %}Create{% endif %} Note
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="location.href='{% url 'managementdailynote_list' %}'">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.form-actions {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
    text-align: right;
}

@media (max-width: 768px) {
    .form-actions {
        text-align: center;
    }
    
    .form-actions .btn {
        margin-bottom: 10px;
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const actionRequiredField = document.getElementById('id_action_required');
    const actionFields = document.getElementById('actionFields');
    const actionDetailsField = document.getElementById('id_action_details');
    const actionDeadlineField = document.getElementById('id_action_deadline');
    
    // Toggle action fields based on action required
    function toggleActionFields() {
        if (actionRequiredField.checked) {
            actionFields.style.display = 'block';
            actionDetailsField.required = true;
            actionDeadlineField.required = true;
        } else {
            actionFields.style.display = 'none';
            actionDetailsField.required = false;
            actionDeadlineField.required = false;
        }
    }
    
    actionRequiredField.addEventListener('change', toggleActionFields);
    toggleActionFields(); // Initial call
    
    // Set default deadline to 7 days from now if not set
    if (!actionDeadlineField.value && actionRequiredField.checked) {
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        actionDeadlineField.value = nextWeek.toISOString().split('T')[0];
    }
    
    // Toggle resolution fields if editing
    {% if object %}
    const isResolvedField = document.getElementById('id_is_resolved');
    const resolutionFields = document.getElementById('resolutionFields');
    const resolutionNotesField = document.getElementById('id_resolution_notes');
    
    function toggleResolutionFields() {
        if (isResolvedField.checked) {
            resolutionFields.style.display = 'block';
            resolutionNotesField.required = true;
        } else {
            resolutionFields.style.display = 'none';
            resolutionNotesField.required = false;
        }
    }
    
    isResolvedField.addEventListener('change', toggleResolutionFields);
    toggleResolutionFields(); // Initial call
    {% endif %}
});
</script>
{% endblock %}