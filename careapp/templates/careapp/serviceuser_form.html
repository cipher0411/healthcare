{% extends 'careapp/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="page-title">
                    <i class="fas fa-user"></i>
                    {% if form.instance.pk %}Edit{% else %}Create{% endif %} Service User
                </h1>
                <div>
                    <a href="{% if form.instance.pk %}{% url 'serviceuser_detail' form.instance.pk %}{% else %}{% url 'serviceuser_list' %}{% endif %}" 
                       class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Cancel
                    </a>
                </div>
            </div>

            <!-- Form -->
            <div class="card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        <!-- Personal Information -->
                        <fieldset class="mb-4">
                            <legend class="border-bottom pb-2">
                                <i class="fas fa-info-circle me-2"></i>Personal Information
                            </legend>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.first_name|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.last_name|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    {{ form.date_of_birth|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.gender|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.marital_status|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.photo|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.bio|as_crispy_field }}
                                </div>
                            </div>
                        </fieldset>

                        <!-- Admission Information -->
                        <fieldset class="mb-4">
                            <legend class="border-bottom pb-2">
                                <i class="fas fa-calendar-alt me-2"></i>Admission Information
                            </legend>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.admission_date|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.discharge_date|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.room_number|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.bed_number|as_crispy_field }}
                                </div>
                            </div>
                            {{ form.discharge_reason|as_crispy_field }}
                        </fieldset>

                        <!-- Contact Information -->
                        <fieldset class="mb-4">
                            <legend class="border-bottom pb-2">
                                <i class="fas fa-address-book me-2"></i>Contact Information
                            </legend>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.email|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.phone_number|as_crispy_field }}
                                </div>
                            </div>
                        </fieldset>

                        <!-- Emergency Contact -->
                        <fieldset class="mb-4">
                            <legend class="border-bottom pb-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>Emergency Contact
                            </legend>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.emergency_contact_name|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.emergency_contact_relationship|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.emergency_contact_phone|as_crispy_field }}
                                </div>
                            </div>
                            {{ form.emergency_contact_address|as_crispy_field }}
                        </fieldset>

                        <!-- Next of Kin -->
                        <fieldset class="mb-4">
                            <legend class="border-bottom pb-2">
                                <i class="fas fa-users me-2"></i>Next of Kin
                            </legend>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.next_of_kin_name|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.next_of_kin_relationship|as_crispy_field }}
                                </div>
                            </div>
                            {{ form.next_of_kin_phone|as_crispy_field }}
                        </fieldset>

                        <!-- Medical Information -->
                        <fieldset class="mb-4">
                            <legend class="border-bottom pb-2">
                                <i class="fas fa-heartbeat me-2"></i>Medical Information
                            </legend>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.allergies|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.medical_conditions|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.special_requirements|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.dietary_restrictions|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.mobility_requirements|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.communication_needs|as_crispy_field }}
                                </div>
                            </div>
                        </fieldset>

                        <!-- Legal Documents -->
                        <fieldset class="mb-4">
                            <legend class="border-bottom pb-2">
                                <i class="fas fa-file-contract me-2"></i>Legal Documents
                            </legend>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.has_advanced_directive|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.has_power_of_attorney|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.advanced_directive_details|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.power_of_attorney_details|as_crispy_field }}
                                </div>
                            </div>
                        </fieldset>

                        <!-- Status -->
                        <fieldset class="mb-4">
                            <legend class="border-bottom pb-2">
                                <i class="fas fa-check-circle me-2"></i>Status
                            </legend>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.funding_source|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.key_worker|as_crispy_field }}
                                </div>
                            </div>
                            {{ form.is_active|as_crispy_field }}
                        </fieldset>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% if form.instance.pk %}{% url 'serviceuser_detail' form.instance.pk %}{% else %}{% url 'serviceuser_list' %}{% endif %}" 
                               class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {% if form.instance.pk %}Update{% else %}Create{% endif %} Service User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Show/hide fields based on checkbox values
    document.addEventListener('DOMContentLoaded', function() {
        // Advanced Directive fields
        const hasAdvancedDirective = document.getElementById('id_has_advanced_directive');
        const advancedDirectiveDetails = document.getElementById('div_id_advanced_directive_details');
        
        function toggleAdvancedDirectiveFields() {
            advancedDirectiveDetails.style.display = hasAdvancedDirective.checked ? 'block' : 'none';
        }
        
        hasAdvancedDirective.addEventListener('change', toggleAdvancedDirectiveFields);
        toggleAdvancedDirectiveFields();
        
        // Power of Attorney fields
        const hasPowerOfAttorney = document.getElementById('id_has_power_of_attorney');
        const powerOfAttorneyDetails = document.getElementById('div_id_power_of_attorney_details');
        
        function togglePowerOfAttorneyFields() {
            powerOfAttorneyDetails.style.display = hasPowerOfAttorney.checked ? 'block' : 'none';
        }
        
        hasPowerOfAttorney.addEventListener('change', togglePowerOfAttorneyFields);
        togglePowerOfAttorneyFields();
        
        // Discharge reason field
        const dischargeDate = document.getElementById('id_discharge_date');
        const dischargeReason = document.getElementById('div_id_discharge_reason');
        
        function toggleDischargeReason() {
            dischargeReason.style.display = dischargeDate.value ? 'block' : 'none';
        }
        
        dischargeDate.addEventListener('change', toggleDischargeReason);
        toggleDischargeReason();
    });
</script>
{% endblock %}